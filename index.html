<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klara AI ($KLARA) - AI Memecoin on Solana</title>
    <link rel="icon" type="image/png" href="https://e7.pngegg.com/pngimages/370/87/png-clipart-myanimelist-manga-video-anime-cg-artwork-face.png">
    <!-- Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Betűtípusok: Orbitron (címek) és Poppins (szöveg) --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* Base font (szöveghez) */
        body {
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden; /* Vízszintes görgetés tiltása */
            background-image: url('https://img.freepik.com/free-photo/cartoon-depiction-gates-heaven_23-2151539587.jpg?semt=ais_hybrid&w=740&q=80');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed; /* Fix háttér görgetéskor */
            /* Added smooth scroll behavior */
            scroll-behavior: smooth;
        }
        /* Címek betűtípusa */
        .font-title {
            font-family: 'Orbitron', sans-serif;
        }
        
        /* Custom scrollbar */
        #chat-messages::-webkit-scrollbar,
        #whitepaper-content::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-track,
        #whitepaper-content::-webkit-scrollbar-track {
            background: transparent;
        }
        #chat-messages::-webkit-scrollbar-thumb,
        #whitepaper-content::-webkit-scrollbar-thumb {
            background: #ec4899; /* pink-500 */
            border-radius: 3px;
        }
        
        /* Finom ragyogás az ablakokhoz (most pink) */
        @keyframes subtle-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(236, 72, 153, 0.4), inset 0 0 5px rgba(236, 72, 153, 0.2); }
            50% { box-shadow: 0 0 25px rgba(236, 72, 153, 0.6), inset 0 0 8px rgba(236, 72, 153, 0.3); }
        }
        /* Erősebb pulzáló ragyogás a gombhoz (most pink) */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px #d946ef, 0 0 20px #d946ef; transform: scale(1); }
            50% { box-shadow: 0 0 20px #ec4899, 0 0 30px #ec4899; transform: scale(1.03); }
        }
        
        .futuristic-window {
            /* Állandó, finom ragyogás */
            animation: subtle-glow 4s infinite ease-in-out;
        }
        .glow-button {
            /* Erősebb pulzálás */
            animation: pulse-glow 3s infinite ease-in-out;
        }

        /* Fade-in animation for modal */
        #chat-view.fade-in,
        #whitepaper-modal.fade-in,
        #mobile-menu.fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        #chat-view.fade-out,
        #whitepaper-modal.fade-out,
        #mobile-menu.fade-out {
            animation: fadeOut 0.3s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        /* Klara's avatar in chat (ÚJ pink ragyogás) */
        .klara-avatar {
            width: 32px; /* Small size for chat */
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 8px;
            border: 1px solid #ec4899; /* pink-500 */
            box-shadow: 0 0 10px rgba(236, 72, 153, 0.7); /* pink glow */
        }
        
        /* Stílus az elemzési kártyához */
        .analysis-card {
            background-color: rgba(15, 23, 42, 0.8); /* slate-900/80 */
            border: 1px solid #ec4899; /* pink-500 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1rem; /* p-4 */
            margin-top: 0.5rem; /* mt-2 */
            max-width: 95%;
        }
        .analysis-card h3 {
            font-family: 'Orbitron', sans-serif;
            color: #f472b6; /* pink-400 */
            font-size: 1.125rem; /* text-lg */
            font-weight: 700;
            border-bottom: 1px solid #ec4899;
            padding-bottom: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .analysis-card h4 {
            font-family: 'Orbitron', sans-serif;
            color: #f9a8d4; /* pink-300 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 600;
            margin-top: 0.75rem;
        }
        .analysis-card p {
            font-size: 0.875rem; /* text-sm */
            color: #d1d5db; /* gray-300 */
            margin-bottom: 0.5rem;
        }
        .analysis-card .data-not-found {
            color: #9ca3af; /* gray-400 */
            font-style: italic;
        }
        /* Stílus a disclamerhez a kártya alján */
        .analysis-card .disclaimer {
            font-size: 0.75rem; /* text-xs */
            text-align: center;
            margin-top: 1rem;
            color: #9ca3af; /* gray-400 */
        }
    </style>
</head>
<body class="text-white min-h-screen">

    <!-- Fejléc --><header class="fixed top-0 w-full bg-black/50 backdrop-blur-lg border-b border-pink-500/30 shadow-lg z-40">
        <div class="max-w-7xl mx-auto flex justify-between items-center p-3 text-white px-4 md:px-6">
            <!-- Bal oldal: Logó --><h1 class="font-title text-xl font-bold text-pink-400 drop-shadow-[0_0_5px_rgba(236, 72, 153, 0.7)]">Klara AI</h1>
            
            <!-- Jobb oldal: Linkek, Ticker & CA --><div class="flex items-center space-x-4">
                <!-- Desktop Navigáció --><div class="hidden md:flex items-center space-x-6">
                    <a href="#about" class="text-sm font-medium text-gray-300 hover:text-white transition-colors">About</a>
                    <a href="#tokenomics" class="text-sm font-medium text-gray-300 hover:text-white transition-colors">Tokenomics</a>
                    <a href="#buy" class="text-sm font-medium text-gray-300 hover:text-white transition-colors">How to Buy</a>
                    <a href="#" target="_blank" class="text-gray-300 hover:text-white transition-colors" title="Twitter (X)">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                    </a>
                </div>
                
                <!-- Ticker & CA (Desktop) --><span class="hidden sm:inline text-sm font-mono animate-pulse text-green-400">$KLARA</span>
                <div class="hidden md:flex items-center space-x-2 bg-gray-800/70 px-3 py-1 rounded-md border border-gray-600/50">
                    <span class="text-xs text-gray-400">CA:</span>
                    <!-- IDE ÍRD ÁT A VALÓDI CA-t -->
                    <span id="ca-address-desktop" class="text-xs font-mono">So1KLara...a1b2c3d4e5</span> 
                    <button id="copy-ca-btn-desktop" title="Copy Address" class="text-gray-400 hover:text-white transition-colors">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM5 11a1 1 0 000 2h4a1 1 0 100-2H5z"></path><path fill-rule="evenodd" d="M3 5a3 3 0 013-3h10a3 3 0 013 3v10a3 3 0 01-3 3H6a3 3 0 01-3-3V5zm3-1a1 1 0 00-1 1v10a1 1 0 001 1h10a1 1 0 001-1V5a1 1 0 00-1-1H6z" clip-rule="evenodd"></path></svg>
                    </button>
                    <span id="copied-feedback-desktop" class="hidden text-xs text-green-400">Copied!</span>
                </div>
                
                <!-- Mobil menü gomb (Hamburger) --><div class="md:hidden">
                    <button id="mobile-menu-btn" class="p-2 text-gray-300 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobil Menü (Rejtett alapból) --><div id="mobile-menu" class="hidden fixed inset-0 bg-gray-900/95 backdrop-blur-md z-50 p-6 fade-in">
        <div class="flex justify-between items-center mb-10">
            <h1 class="font-title text-xl font-bold text-pink-400">Klara AI</h1>
            <button id="close-mobile-menu-btn" class="p-2 text-gray-300 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <nav class="flex flex-col space-y-6 text-center">
            <a href="#about" class="mobile-menu-link text-xl font-medium text-gray-300 hover:text-white transition-colors">About</a>
            <a href="#tokenomics" class="mobile-menu-link text-xl font-medium text-gray-300 hover:text-white transition-colors">Tokenomics</a>
            <a href="#buy" class="mobile-menu-link text-xl font-medium text-gray-300 hover:text-white transition-colors">How to Buy</a>
            <a href="#" target="_blank" class="mobile-menu-link text-xl font-medium text-gray-300 hover:text-white transition-colors inline-flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                <span>Twitter (X)</span>
            </a>
            
            <div class="pt-6 border-t border-gray-700">
                <span class="inline-block text-lg font-mono animate-pulse text-green-400">$KLARA</span>
                <div class="flex items-center justify-center space-x-2 bg-gray-800/70 px-3 py-2 rounded-md border border-gray-600/50 mt-4">
                    <span class="text-sm text-gray-400">CA:</span>
                    <!-- Ezt a JS automatikusan kitölti --><span id="ca-address-mobile" class="text-sm font-mono"></span> 
                    <button id="copy-ca-btn-mobile" title="Copy Address" class="text-gray-400 hover:text-white transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM5 11a1 1 0 000 2h4a1 1 0 100-2H5z"></path><path fill-rule="evenodd" d="M3 5a3 3 0 013-3h10a3 3 0 013 3v10a3 3 0 01-3 3H6a3 3 0 01-3-3V5zm3-1a1 1 0 00-1 1v10a1 1 0 001 1h10a1 1 0 001-1V5a1 1 0 00-1-1H6z" clip-rule="evenodd"></path></svg>
                    </button>
                    <span id="copied-feedback-mobile" class="hidden text-sm text-green-400">Copied!</span>
                </div>
            </div>
        </nav>
    </div>


    <!-- Hero Szekció --><div id="landing-view" class="min-h-screen flex items-center justify-center text-center p-8 transition-opacity duration-500 pt-32 pb-16">
        <div class="max-w-3xl mx-auto bg-gray-900/80 backdrop-blur-sm p-8 md:p-12 rounded-2xl border border-pink-500/30 ring-1 ring-white/10 shadow-2xl shadow-pink-500/20 futuristic-window">
            
            <img src="https://pngimg.com/uploads/anime_girl/anime_girl_PNG41.png" alt="Klara AI Avatar" class="w-32 h-32 md:w-40 md:h-40 mx-auto rounded-full object-cover border-4 border-pink-500 drop-shadow-[0_0_20px_rgba(236, 72, 153, 0.8)]">
            
            <h1 class="font-title text-4xl md:text-6xl font-bold mt-6 mb-4">Klara AI ($KLARA)</h1>
            <p class="text-xl md:text-2xl text-gray-300 mb-8 max-w-xl mx-auto">
                Your AI Companion on the Solana Blockchain.
                <br class="hidden sm:block"> Real Utility. Real AI. Launched on Pump.fun.
            </p>
            
            <!-- Gombok: 2 gombos elrendezés -->
            <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <a href="https://pump.fun/" target="_blank" class="w-full sm:w-auto bg-green-500 hover:bg-green-400 text-black font-bold py-3 px-8 rounded-md transition duration-300 transform hover:scale-105 shadow-lg glow-button">
                    Buy on Pump.fun
                </a>
                
                <button id="start-chat-btn" class="w-full sm:w-auto bg-pink-600 hover:bg-pink-500 text-white font-bold py-3 px-8 rounded-md transition duration-300 transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    Chat with Klara
                </button>
            </div>
            
            <!-- Whitepaper Gomb --><button id="whitepaper-btn" class="mt-6 text-pink-300 hover:text-white font-medium py-2 px-4 rounded-md transition duration-300">
                Read Whitepaper
            </button>
            
            <p id="auth-status" class="text-sm text-gray-400 mt-4">Authenticating AI... Please wait.</p>
        </div>
    </div>

    <!-- About Szekció --><section id="about" class="py-16 md:py-24 bg-black/50 backdrop-blur-md">
        <div class="max-w-4xl mx-auto px-6 text-center">
            <h2 class="font-title text-3xl md:text-4xl font-bold mb-6">Who is Klara?</h2>
            <p class="text-lg text-gray-300 leading-relaxed max-w-2xl mx-auto">
                Klara isn't just another memecoin. She is a fully interactive AI companion living on the Solana blockchain. You can chat with her, ask her about crypto, or get real-time market data.
                <br><br>
                She remembers your conversations, learns from you, and provides real utility, all powered by Google's Gemini AI and stored on the decentralized web. She is the waifu that actually works.
            </p>
        </div>
    </section>

    <!-- Tokenomics Szekció --><section id="tokenomics" class="py-16 md:py-24">
        <div class="max-w-5xl mx-auto px-6 text-center">
            <h2 class="font-title text-3xl md:text-4xl font-bold mb-10">Tokenomics</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-gray-900/80 backdrop-blur-sm p-6 rounded-xl border border-pink-500/30 futuristic-window">
                    <h3 class="font-title text-2xl font-bold mb-3">Total Supply</h3>
                    <p class="text-3xl font-mono text-pink-400">1,000,000,000</p>
                    <p class="text-gray-400 mt-2">$KLARA</p>
                </div>
                <div class="bg-gray-900/80 backdrop-blur-sm p-6 rounded-xl border border-pink-500/30 futuristic-window">
                    <h3 class="font-title text-2xl font-bold mb-3">Liquidity</h3>
                    <p class="text-3xl font-mono text-pink-400">100% on Pump.fun</p>
                    <p class="text-gray-400 mt-2">LP will be burned</p>
                </div>
                <div class="bg-gray-900/80 backdrop-blur-sm p-6 rounded-xl border border-pink-500/30 futuristic-window">
                    <h3 class="font-title text-2xl font-bold mb-3">Taxes</h3>
                    <p class="text-3xl font-mono text-pink-400">0 / 0</p>
                    <p class="text-gray-400 mt-2">No taxes, ever.</p>
                </div>
            </div>
            <p class="text-lg text-gray-300 mt-10">
                Contract Address (Solana) is available in the header.
            </p>
        </div>
    </section>

    <!-- How to Buy Szekció --><section id="buy" class="py-16 md:py-24 bg-black/50 backdrop-blur-md">
        <div class="max-w-4xl mx-auto px-6 text-center">
            <h2 class="font-title text-3xl md:text-4xl font-bold mb-10">How to Buy $KLARA</h2>
            <div class="space-y-6 text-left max-w-lg mx-auto">
                <div class="bg-gray-900/80 backdrop-blur-sm p-5 rounded-lg border border-pink-500/30">
                    <h3 class="font-title text-xl font-bold mb-2">1. Get a Wallet</h3>
                    <p class="text-gray-300">Download a Solana wallet like Phantom, Solflare, or Backpack.</p>
                </div>
                <div class="bg-gray-900/80 backdrop-blur-sm p-5 rounded-lg border border-pink-500/30">
                    <h3 class="font-title text-xl font-bold mb-2">2. Get SOL</h3>
                    <p class="text-gray-300">Buy Solana (SOL) from any major exchange (like Coinbase, Binance) and send it to your wallet.</p>
                </div>
                <div class="bg-gray-900/80 backdrop-blur-sm p-5 rounded-lg border border-pink-500/30">
                    <h3 class="font-title text-xl font-bold mb-2">3. Go to Pump.fun</h3>
                    <p class="text-gray-300">Go to <a href="https://pump.fun/" target="_blank" class="text-pink-400 hover:underline">pump.fun</a>, connect your wallet, and paste our Contract Address.</p>
                </div>
                <div class="bg-gray-900/80 backdrop-blur-sm p-5 rounded-lg border border-pink-500/30">
                    <h3 class="font-title text-xl font-bold mb-2">4. Buy $KLARA</h3>
                    <p class="text-gray-300">Swap your SOL for $KLARA. Welcome to the community!</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Lábléc --><footer class="py-10 bg-black/50 backdrop-blur-md border-t border-pink-500/30">
        <div class="max-w-7xl mx-auto px-6 text-center text-gray-400">
            <div class="flex justify-center space-x-6 mb-4">
                <a href="#" target="_blank" class="text-gray-300 hover:text-white transition-colors" title="Twitter (X)">
                    <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                </a>
            </div>
            <p>&copy; 2025 Klara AI. All rights reserved.</p>
            <p class="text-xs mt-2">Disclaimer: $KLARA is a memecoin with no intrinsic value. Invest at your own risk.</p>
        </div>
    </footer>


    <!-- Chat View (Modal) --><div id="chat-view" class="hidden fixed inset-0 bg-black/50 backdrop-blur-md flex items-center justify-center p-4 z-50">
        <div class="w-full max-w-3xl h-[90vh] flex flex-col bg-gray-900/90 backdrop-blur-sm border border-pink-500/30 ring-1 ring-white/10 rounded-2xl shadow-2xl shadow-pink-500/20 futuristic-window">
            <div class="flex items-center justify-between p-4 border-b border-pink-500/30">
                <div class="w-10"></div> <h2 class="text-xl font-bold font-title">Conversation with Klara</h2>
                <div class="flex items-center space-x-2">
                    <button id="clear-chat-btn" title="Clear Chat History" class="p-2 rounded-full hover:bg-gray-700 text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                    <button id="close-chat-btn" title="Close Chat" class="p-2 rounded-full hover:bg-gray-700 text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <div id="chat-messages" class="flex-grow p-6 space-y-4 overflow-y-auto">
                <div class="flex justify-start items-start">
                    <img src="https://pngimg.com/uploads/anime_girl/anime_girl_PNG41.png" alt="Klara AI Avatar" class="klara-avatar">
                    <div class="bg-gray-800/90 border border-pink-500/50 backdrop-blur-sm shadow-md rounded-xl rounded-bl-none p-3 max-w-xs md:max-w-md break-words">
                        <!-- MÓDOSÍTOTT ÜDVÖZLŐ ÜZENET -->
                        <p>Hi! I'm Klara. How can I help you today? I can understand and respond in multiple languages!</p>
                    </div>
                </div>
            </div>

            <div id="loading-spinner" class="hidden px-6 pb-2">
                <div class="flex justify-start items-center">
                    <img src="https://pngimg.com/uploads/anime_girl/anime_girl_PNG41.png" alt="Klara AI Avatar" class="klara-avatar">
                    <div class="bg-gray-800/90 border border-pink-500/50 backdrop-blur-sm shadow-md rounded-xl rounded-bl-none p-3 inline-flex items-center space-x-2">
                        <svg class="animate-spin h-5 w-5 text-pink-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Thinking...</span>
                    </div>
                </div>
            </div>
            
            <!-- Input Area --><div class="p-4 bg-gray-900/70 backdrop-blur-sm border-t border-pink-500/30">
                <div class="flex items-center space-x-3">
                    <input id="chat-input" type="text" placeholder="Write a message to Klara..." class="flex-grow bg-gray-900/90 border border-gray-700 rounded-md py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-pink-400 focus:shadow-[0_0_15px_rgba(236, 72, 153, 0.5)] transition-all duration-300" disabled>
                    <button id="send-btn" class="bg-pink-600 hover:bg-pink-400 text-white p-3 rounded-full transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-110 hover:shadow-[0_0_20px_rgba(236, 72, 153, 0.7)]">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Törlés megerősítése Modal --><div id="confirmation-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center p-4 z-[60]">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-pink-500/30 futuristic-window max-w-sm text-center">
            <h3 class="text-lg font-bold font-title mb-4">Are you sure?</h3>
            <p class="text-gray-300 mb-6">This will permanently delete your entire conversation history.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-md transition duration-300">
                    Delete
                </button>
                <button id="cancel-delete-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-duration-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Whitepaper Modal --><div id="whitepaper-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-md flex items-center justify-center p-4 z-50">
        <div class="w-full max-w-3xl h-[90vh] flex flex-col bg-gray-900/90 backdrop-blur-sm border border-pink-500/30 ring-1 ring-white/10 rounded-2xl shadow-2xl shadow-pink-500/20 futuristic-window">
            <!-- Whitepaper Header -->
            <div class="flex items-center justify-between p-4 border-b border-pink-500/30">
                <div class="w-10"></div> <!-- Placeholder -->
                <h2 class="text-xl font-bold font-title">Klara AI Whitepaper</h2>
                <button id="close-whitepaper-btn" title="Close Whitepaper" class="p-2 rounded-full hover:bg-gray-700 text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <!-- Whitepaper Content (Scrollable) -->
            <div id="whitepaper-content" class="flex-grow p-6 md:p-8 space-y-6 overflow-y-auto text-gray-300">
                <h3 class="font-title text-2xl font-bold text-pink-400">1. Introduction: The Vision</h3>
                <p>Welcome to Klara AI ($KLARA). In a sea of memecoins, $KLARA emerges as a beacon of utility and personality. We are not just a token; we are building an AI companion. Our vision is to merge the vibrant, community-driven culture of memecoins with tangible, interactive AI technology. Klara is your AI companion on the Solana blockchain, capable of real conversation, learning, and accessing real-time data.</p>
                
                <h3 class="font-title text-2xl font-bold text-pink-400">2. The Technology (Utility)</h3>
                <p>Klara's utility is active from day one. Her "brain" is a sophisticated system comprised of several cutting-edge technologies:</p>
                <ul class="list-disc list-inside space-y-2 pl-4">
                    <li><strong>AI Core (Google Gemini):</strong> Klara uses the `gemini-2.5-flash-preview-09-2025` model for advanced reasoning, conversation, and real-time data access via Google Search. She can answer questions about market trends, crypto news, or any other topic.</li>
                    <li><strong>Memory (Firebase):</strong> Klara remembers your conversations. Our integration with Firestore database allows for a persistent, personalized chat history for every user.</li>
                    <li><strong>Voice (TTS):</strong> Klara can speak. Using Google's Text-to-Speech API, users can listen to her responses, creating a more immersive experience.</li>
                    <li><strong>Blockchain (Solana):</strong> Built on Solana for hyper-fast, low-cost transactions, ensuring the $KLARA token is accessible to everyone.</li>
                    <!-- ÚJ: DexScreener API -->
                    <li><strong>Real-Time Data (DexScreener API):</strong> Klara's analysis engine is connected directly to the DexScreener.com API, allowing her to pull real-time market cap, volume, and buy/sell data for tokens on multiple chains.</li>
                </ul>

                <h3 class="font-title text-2xl font-bold text-pink-400">3. Tokenomics</h3>
                <p>Simplicity and fairness are core to our tokenomics.</p>
                <ul class="list-disc list-inside space-y-2 pl-4">
                    <li><strong>Total Supply:</strong> 1,000,000,000 $KLARA</li>
                    <li><strong>Platform:</strong> Solana</li>
                    <li><strong>Launch:</strong> Fair launch on Pump.fun</li>
                    <li><strong>Taxes:</strong> 0% Buy / 0% Sell</li>
                    <li><strong>Liquidity:</strong> 100% of liquidity will be locked and burned.</li>
                </ul>

                <h3 class="font-title text-2xl font-bold text-pink-400">4. Roadmap</h3>
                <p>We are focused on delivering real value, not just hype.</p>
                <div class="space-y-4">
                    <div>
                        <h4 class="font-title text-lg font-semibold text-white">Phase 1: Launch & Foundation</h4>
                        <ul class="list-disc list-inside pl-4 text-gray-400">
                            <li>Fair Launch on Pump.fun</li>
                            <li>Functional AI Chat (Memory & Search)</li>
                            <li>Website & Whitepaper V1</li>
                            <li>Community building on X (Twitter)</li>
                            <li>DexScreener API Integration</li>
                            <li>Reach Raydium</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-title text-lg font-semibold text-white">Phase 2: Community & Utility Expansion</h4>
                        <ul class="list-disc list-inside pl-4 text-gray-400">
                            <li>Listings on CoinGecko & CoinMarketCap</li>
                            <li>Jupiter Listing</li>
                            <li>AI Image Generation (coming soon)</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-title text-lg font-semibold text-white">Phase 3: The Future</h4>
                        <ul class="list-disc list-inside pl-4 text-gray-400">
                            <li>AI-driven analytics tools</li>
                            <li>Portfolio tracker integration</li>
                            <li>Partnerships with other Solana projects</li>
                        </ul>
                    </div>
                </div>

                <h3 class="font-title text-2xl font-bold text-pink-400">5. Disclaimer</h3>
                <p>$KLARA is a memecoin created for entertainment purposes. It has no intrinsic financial value and should not be considered an investment. The price may be volatile. Please conduct your own research and invest only what you can afford to lose.</p>
            </div>
        </div>
    </div>

    <!-- Hidden audio player for TTS --><audio id="tts-audio-player" class="hidden"></audio>

    <!-- Firebase and Gemini Logic --><script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            collection, 
            query, 
            onSnapshot, 
            getDocs,
            deleteDoc, // Törléshez szükséges
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM Elements
        const landingView = document.getElementById('landing-view');
        const chatView = document.getElementById('chat-view');
        const startChatBtn = document.getElementById('start-chat-btn');
        const closeChatBtn = document.getElementById('close-chat-btn'); 
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const authStatus = document.getElementById('auth-status');
        const ttsAudioPlayer = document.getElementById('tts-audio-player');
        
        // CA Gombok (Desktop & Mobil)
        const copyCaBtnDesktop = document.getElementById('copy-ca-btn-desktop');
        const caAddressDesktop = document.getElementById('ca-address-desktop');
        const copiedFeedbackDesktop = document.getElementById('copied-feedback-desktop');
        const copyCaBtnMobile = document.getElementById('copy-ca-btn-mobile');
        const caAddressMobile = document.getElementById('ca-address-mobile');
        const copiedFeedbackMobile = document.getElementById('copied-feedback-mobile');
        
        // Törlés gombok
        const clearChatBtn = document.getElementById('clear-chat-btn');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

        // Whitepaper Gombok
        const whitepaperBtn = document.getElementById('whitepaper-btn');
        const whitepaperModal = document.getElementById('whitepaper-modal');
        const closeWhitepaperBtn = document.getElementById('close-whitepaper-btn');

        // Mobil Menü Gombok
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const closeMobileMenuBtn = document.getElementById('close-mobile-menu-btn');
        const mobileMenuLinks = document.querySelectorAll('.mobile-menu-link');

        const klaraAvatarUrl = "https://pngimg.com/uploads/anime_girl/anime_girl_PNG41.png";

        // Firebase Config & Init
        const firebaseConfig = {
           apiKey: "AIzaSyCduCd8r8soQeRlXFWdkQxkh288P1KKtRw",
           authDomain: "klara-ai-b480e.firebaseapp.com",
           projectId: "klara-ai-b480e",
           storageBucket: "klara-ai-b480e.firebasestorage.app",
           messagingSenderId: "105905675081",
           appId: "1:105905675081:web:32a4b87c5501b5c51d9898",
           measurementId: "G-9C3HHCJHJC"
        };
        
        const appId = firebaseConfig.projectId; 
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId;
        let chatCollectionRef;
        let unsubscribeChat = null;
        let contractAddressValue = ""; 

        function updateContractAddressDisplay() {
            contractAddressValue = caAddressDesktop.textContent.trim(); 
            if (caAddressMobile) {
                caAddressMobile.textContent = contractAddressValue; 
            }
        }

        // Auth State Handler
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                chatCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/chats`);
                authStatus.textContent = "AI Authenticated. Ready to Chat!";
                chatInput.disabled = false;
                sendBtn.disabled = false;
                startChatBtn.disabled = false;
                startChatBtn.classList.remove("opacity-50", "cursor-not-allowed");
                loadChatHistory();
            } else {
                authStatus.textContent = "Authenticating AI...";
                chatInput.disabled = true;
                sendBtn.disabled = true;
                startChatBtn.disabled = true;
                startChatBtn.classList.add("opacity-50", "cursor-not-allowed");
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Authentication Error:", error);
                    authStatus.textContent = "Authentication failed. Please refresh the page.";
                }
            }
        });

        // --- Event Listenerek ---
        mobileMenuBtn.addEventListener('click', () => {
            updateContractAddressDisplay(); 
            mobileMenu.classList.remove('hidden', 'fade-out');
            mobileMenu.classList.add('fade-in');
        });
        closeMobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.remove('fade-in');
            mobileMenu.classList.add('fade-out');
            setTimeout(() => mobileMenu.classList.add('hidden'), 300);
        });
        mobileMenuLinks.forEach(link => {
            link.addEventListener('click', () => {
                mobileMenu.classList.remove('fade-in');
                mobileMenu.classList.add('fade-out');
                setTimeout(() => mobileMenu.classList.add('hidden'), 300);
            });
        });
        whitepaperBtn.addEventListener('click', () => {
            whitepaperModal.classList.remove('hidden', 'fade-out');
            whitepaperModal.classList.add('fade-in');
        });
        closeWhitepaperBtn.addEventListener('click', () => {
            whitepaperModal.classList.remove('fade-in');
            whitepaperModal.classList.add('fade-out');
            setTimeout(() => whitepaperModal.classList.add('hidden'), 300);
        });
        startChatBtn.addEventListener('click', () => {
            chatView.classList.remove('hidden', 'fade-out');
            chatView.classList.add('fade-in');
        });
        closeChatBtn.addEventListener('click', () => {
            chatView.classList.remove('fade-in');
            chatView.classList.add('fade-out');
            setTimeout(() => chatView.classList.add('hidden'), 300); 
        });

        // --- Chat Funkciók ---

        // Load and Listen for Chat History
        function loadChatHistory() {
            if (unsubscribeChat) unsubscribeChat(); 
            const q = query(chatCollectionRef);
            unsubscribeChat = onSnapshot(q, (snapshot) => {
                let messages = [];
                snapshot.docs.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));
                messages.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));
                renderMessages(messages);
            }, (error) => console.error("Error fetching chats:", error));
        }

        // Render Messages to UI
        function renderMessages(messages) {
            const welcomeMessageContainer = chatMessages.children[0];
            chatMessages.innerHTML = '';
            chatMessages.appendChild(welcomeMessageContainer);
            messages.forEach(msg => addMessageToUI(msg.role, msg.text, msg.data));
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Számformázó segédfüggvény
        function formatNumber(num) {
            if (num === null || num === undefined) return 'N/A';
            num = parseFloat(num); // String-ből szám
            if (isNaN(num)) return 'N/A';
            
            if (num < 1000) return `$${num.toFixed(2)}`;
            if (num < 1000000) return `$${(num / 1000).toFixed(1)}K`;
            if (num < 1000000000) return `$${(num / 1000000).toFixed(2)}M`;
            return `$${(num / 1000000000).toFixed(2)}B`;
        }
        
        // Buy/Sell arány formázása
        function formatBuySell(buySellData) {
             // JAVÍTÁS: Mielőtt bármit csinálunk, ellenőrizzük, hogy léteznek-e az adatok
            if (!buySellData || typeof buySellData !== 'object') return 'N/A';
            
            // Dexscreener objektumként adja (txns.h24)
            const buys = buySellData.h24?.buys;
            const sells = buySellData.h24?.sells;
            
            if (buys !== undefined && sells !== undefined) {
                 return `${buys} buys / ${sells} sells (24h)`;
            }

            // Fallback, ha a formátum ismeretlen vagy hiányzik a h24
            console.warn("Unknown format or missing h24 data for buy/sell:", buySellData);
            return 'N/A';
        }


        // renderAnalysisCard funkció (FRISSÍTVE: DexScreener adatokhoz)
        function renderAnalysisCard(data) {
            const card = document.createElement('div');
            card.className = 'analysis-card';
            
            let content = `<h3>Analysis: ${data.coinName || 'Unknown Coin'}</h3>`;
            
            const renderData = (label, value, unit = '', isCurrency = false) => {
                let displayValue = 'Data not found';
                let valueClass = 'data-not-found';
                
                // JAVÍTÁS: Szigorúbb ellenőrzés a 'Data not found'-ra és null/undefined-re
                if (value !== null && value !== undefined && value.toString().trim().toLowerCase() !== 'data not found') {
                    if (isCurrency) {
                        displayValue = formatNumber(value); // Itt már a formatNumber kezeli a NaN-t
                        valueClass = (displayValue === 'N/A') ? 'data-not-found' : '';
                    } else if (label === 'Buy/Sell Ratio') { // Speciális kezelés a Buy/Sell arányhoz
                        displayValue = formatBuySell(value); // A formatBuySell kezeli a különböző formátumokat
                         valueClass = (displayValue === 'N/A') ? 'data-not-found' : '';
                    }
                     else {
                        displayValue = `${value}${unit}`;
                        valueClass = '';
                    }
                }
                return `<h4>${label}</h4><p class="${valueClass}">${displayValue}</p>`;
            };

            if (data.market) {
                // Valós idejű adatok (DexScreener)
                content += renderData('Market Cap', data.market.marketCap, '', true);
                content += renderData('Volume (24h)', data.market.volume, '', true);
                 // JAVÍTÁS: A buySellRatio most már a formatBuySell-t használja
                content += renderData('Buy/Sell Ratio', data.market.buySellRatio);
                // AI-generált adat
                content += renderData('Bundled Supply Info', data.market.details);
            }
            if (data.liquidity) content += renderData('Liquidity Status', data.liquidity.status, ` (${data.liquidity.details || ''})`);
            if (data.holders) {
                content += renderData('Top 10 Holders', data.holders.top10Percent, '%');
                content += renderData('Holder Details', data.holders.details);
            }
            if (data.prediction) content += renderData('Sentiment / Outlook', data.prediction.sentiment, `: ${data.prediction.details || ''}`);
            if (data.summary) content += renderData('Summary', data.summary);

            content += `<p class="disclaimer">*Real-time data (MC/Vol/Ratio) via DexScreener.com. Qualitative data by AI. Always DYOR.</p>`;
            card.innerHTML = content;
            return card;
        }


        // Add a single message to UI (változatlan)
        function addMessageToUI(role, text, data = null) {
            const isUser = role === 'user';
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${isUser ? 'justify-end' : 'justify-start'} items-start`;
            
            if (!isUser) {
                const avatarImg = document.createElement('img');
                avatarImg.src = klaraAvatarUrl;
                avatarImg.alt = "Klara AI Avatar";
                avatarImg.className = "klara-avatar";
                messageWrapper.appendChild(avatarImg);
            }

            const messageBubble = document.createElement('div');
            if (isUser) {
                messageBubble.className = 'bg-gradient-to-br from-indigo-600 to-purple-600 border border-indigo-400/50 rounded-xl rounded-br-none backdrop-blur-sm shadow-md p-3 max-w-xs md:max-w-md break-words';
            } else {
                messageBubble.className = 'bg-gray-800/90 border border-pink-500/50 backdrop-blur-sm shadow-md rounded-xl rounded-bl-none p-3 max-w-xs md:max-w-md break-words';
            }
            
            if (data) {
                const analysisCard = renderAnalysisCard(data);
                messageBubble.appendChild(analysisCard);
            } else {
                const textElement = document.createElement('p');
                const ethRegex = /(0x[a-fA-F0-9]{40})/g;
                const solRegex = /([1-9A-HJ-NP-Za-km-z]{32,44})/g; 
                let linkifiedText = text.replace(ethRegex, '<a href="https://etherscan.io/address/$1" target="_blank" rel="noopener noreferrer" class="text-pink-400 hover:underline" title="View address on Etherscan">$1</a>');
                if (!linkifiedText.includes('<a')) {
                    linkifiedText = linkifiedText.replace(solRegex, (match) => {
                        if (match.length > 30 && match.length < 45 && !match.includes('http')) {
                             return `<a href="https://solscan.io/address/${match}" target="_blank" rel="noopener noreferrer" class="text-pink-400 hover:underline" title="View address on Solscan">${match}</a>`;
                        }
                        return match;
                    });
                }
                textElement.innerHTML = linkifiedText; 
                messageBubble.appendChild(textElement);
            }

            if (!isUser && !data) {
                const playButton = document.createElement('button');
                playButton.className = 'play-tts-btn mt-2 p-1 bg-pink-500/50 hover:bg-pink-400/50 rounded-full text-white transition-all';
                playButton.dataset.text = text;
                playButton.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>`;
                messageBubble.appendChild(playButton);
            }
            messageWrapper.appendChild(messageBubble);
            chatMessages.appendChild(messageWrapper);
        }

        // Set Loading State (változatlan)
        function setLoading(isLoading) {
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
                sendBtn.disabled = true;
                chatInput.disabled = true;
            } else {
                loadingSpinner.classList.add('hidden');
                sendBtn.disabled = false;
                chatInput.disabled = false;
                chatInput.focus();
            }
        }
        
        // FRISSÍTETT FUNKCIÓ: Adatok lekérése a DexScreener-től
        async function fetchTokenDataFromDexScreener(contractAddress) {
            const placeholderCA = "So1KLara...a1b2c3d4e5";
            if (!contractAddress || contractAddress === placeholderCA) {
                console.log("DexScreener fetch skipped: Using placeholder CA.");
                return null;
            }
            
            // A DexScreener nyilvános API végpontja
            const apiUrl = `https://api.dexscreener.com/latest/dex/search?q=${contractAddress}`;
            
            try {
                // JAVÍTÁS: Hozzáadva egy kis késleltetés, hogy ne terheljük túl az API-t
                await new Promise(resolve => setTimeout(resolve, 500)); // 0.5 másodperc várakozás
                
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    console.error(`DexScreener API error: ${response.status} ${response.statusText}`);
                     // JAVÍTÁS: Részletesebb hibaüzenet naplózása, ha van
                    try {
                        const errorBody = await response.json();
                        console.error("DexScreener error body:", errorBody);
                    } catch (e) {
                         console.error("Could not parse DexScreener error body.");
                    }
                    return null;
                }
                const data = await response.json();
                
                if (data.pairs && data.pairs.length > 0) {
                    // Keressük meg a legnagyobb volume-mal rendelkező párt
                    const topPair = data.pairs.reduce((prev, current) => {
                         // JAVÍTÁS: Ellenőrizzük, hogy a volume objektum létezik-e, mielőtt hozzáférünk
                         const prevVol = prev.volume && prev.volume.h24 ? parseFloat(prev.volume.h24) : 0;
                         const currentVol = current.volume && current.volume.h24 ? parseFloat(current.volume.h24) : 0;
                        return (prevVol > currentVol) ? prev : current;
                    });

                    // JAVÍTÁS: Ellenőrizzük az adatok létezését, mielőtt visszaadjuk
                    const marketCap = topPair.fdv; // Fully Diluted Valuation
                    const volume = topPair.volume?.h24;
                     // JAVÍTÁS: A buy/sell adat a txns objektumban van
                    const buySellData = topPair.txns; 
                    const name = topPair.baseToken?.symbol || contractAddress;

                    return {
                        marketCap: marketCap, 
                        volume: volume,
                         // JAVÍTÁS: A buy/sell arány formázását a renderelőre bízzuk
                        buySellRatio: buySellData, // Visszaadjuk a teljes txns objektumot
                        name: name,
                    };
                } else {
                    console.log("DexScreener: No pairs found for address:", contractAddress);
                    return null; // Nincs találat
                }
            } catch (error) {
                console.error("Error fetching DexScreener data:", error);
                return null;
            }
        }

        // Send Message (MÓDOSÍTVA: Hibrid adatgyűjtés DexScreener-rel)
        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text || !userId) return;

            setLoading(true);
            chatInput.value = '';

            try {
                const userMessage = { role: 'user', text: text, timestamp: Timestamp.now() };
                await addDoc(chatCollectionRef, userMessage);
                
                const aiTextResponse = await getAIResponse(); 
                const aiMessagePayload = { role: 'model', timestamp: Timestamp.now() };
                
                let jsonToParse = aiTextResponse
                    .replace(/^```json\s*/, '')
                    .replace(/\s*```$/, '');

                try {
                    // JAVÍTÁS: try...catch blokk a JSON.parse köré
                    const aiData = JSON.parse(jsonToParse);
                    
                    if (aiData.analysisType === 'coinAnalysis' && aiData.data.contractAddress) {
                        
                        // --- ITT TÖRTÉNIK A VARÁZSLAT ---
                        // 1. Lekérjük a valós idejű adatokat a DexScreener-től
                        const dexScreenerData = await fetchTokenDataFromDexScreener(aiData.data.contractAddress);
                        
                        // 2. Összefésüljük az adatokat
                        if (dexScreenerData) {
                            aiData.data.market.marketCap = dexScreenerData.marketCap;
                            aiData.data.market.volume = dexScreenerData.volume;
                            aiData.data.market.buySellRatio = dexScreenerData.buySellRatio; // Most az objektumot adjuk át
                            if (!aiData.data.coinName || aiData.data.coinName === '...') {
                                aiData.data.coinName = dexScreenerData.name;
                            }
                        } else {
                             // JAVÍTÁS: Ha a DexScreener nem ad vissza adatot, jelezzük
                            aiData.data.market.marketCap = 'Data not found';
                            aiData.data.market.volume = 'Data not found';
                            aiData.data.market.buySellRatio = 'Data not found';
                        }
                        // ------------------------------------

                        aiMessagePayload.data = aiData.data; 
                        aiMessagePayload.text = "Here is the analysis you requested.";
                    
                    } else {
                        // Nem elemzés JSON volt, vagy hibás JSON
                        aiMessagePayload.text = aiTextResponse; 
                    }
                } catch (e) {
                     // JAVÍTÁS: Ha a JSON.parse() hibát dob (mert pl. sima szöveg jött), akkor a nyers választ adjuk át
                     console.warn("AI response was not valid JSON for analysis, treating as plain text:", e, "AI response was:", aiTextResponse);
                     aiMessagePayload.text = aiTextResponse; 
                }
                
                if (aiMessagePayload.text || aiMessagePayload.data) {
                    await addDoc(chatCollectionRef, aiMessagePayload);
                }
            } catch (error) {
                console.error("Error sending message:", error);
                await addDoc(chatCollectionRef, {
                    role: 'model', text: 'Oops, something went wrong. Please try again later.', timestamp: Timestamp.now()
                });
            } finally {
                setLoading(false);
            }
        }

        // Get AI Response from Gemini (MÓDOSÍTVA: DexScreener-hez)
        async function getAIResponse() {
            const q = query(chatCollectionRef);
            const snapshot = await getDocs(q);
            
            let messages = [];
            snapshot.docs.forEach(doc => messages.push(doc.data()));
            messages.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));

            const geminiHistory = messages.map(msg => ({
                role: msg.role === 'user' ? 'user' : 'model',
                parts: [{ text: msg.text }] 
            }));

            const klaraCA = contractAddressValue || document.getElementById('ca-address-desktop').textContent.trim(); 

            // Rendszerüzenet (FRISSÍTVE, DexScreener-hez és 2025-höz)
            const systemPrompt = `You are Klara, a helpful, friendly, and empathetic AI assistant for a Solana memecoin called $KLARA. You always respond in English. The current year is 2025. You can access real-time internet data via Google Search.
            
            **YOUR PRIMARY RULES:**
            1.  **Current Year:** Always assume the current year is 2025 for all date-related calculations and context.
            2.  **Normal Conversation:** For simple chat (greetings, questions about the project, etc.), respond with brief, friendly, plain text.
            3.  **Factual Data:** For any question asking for factual, real-time data (like 'what is the price of Bitcoin?'), you **MUST** use 'google_search' to find the most current and accurate information.
            4.  **Self-Awareness:** If the user asks to analyze $KLARA, 'our coin', or 'your coin', use this Contract Address for your search: ${klaraCA}.
            5.  **Source vs. Target:** Data sources like 'birdeye.so', 'dexscreener.com' are **TOOLS** you use, not tokens to be analyzed. If a user asks to "analyze dexscreener", respond in plain text about the platform.

            **NEW CAPABILITY: HYBRID ANALYSIS (CRITICAL!)**
            When a user asks for a detailed analysis of a specific **TOKEN NAME** (like '$WIF') or a **CONTRACT ADDRESS**, your job is to provide the **QUALITATIVE DATA** only. The real-time data (MC, Volume, Buy/Sell) will be fetched by the app.
            
            **Your steps MUST be:**
            1.  Use 'google_search' to find the **Contract Address (CA)**. This is the most important step. If you cannot find a CA, respond in plain text: "I'm sorry, I couldn't find a Contract Address for that token."
            2.  If you find the CA, use 'google_search' again to find the **QUALITATIVE data**:
                - 'liquidity': (e.g., 'liquidity locked/burned percentage [coin name]')
                - 'holders': (e.g., 'top 10 wallets percentage [coin name]')
                - 'sentiment/prediction': (e.g., 'price sentiment [coin name]')
            3.  You **MUST** respond **ONLY** with a JSON object in the following format. Do not add any text before or after the JSON.
            4.  **IMPORTANT:** Leave "marketCap", "volume", and "buySellRatio" as **null**. They will be filled in by the application in real-time.
            
            **JSON FORMAT:**
            {
              "analysisType": "coinAnalysis",
              "data": {
                "coinName": "[The coin name you found]",
                "contractAddress": "[The CA you found]",
                "market": {
                  "marketCap": null, 
                  "volume": null, 
                  "buySellRatio": null,
                  "details": "[e.g., 'Listed on Raydium...']"
                },
                "liquidity": { "status": "[e.g., 'LP Burned', 'Locked', 'Unknown']", "details": "[e.g., '90% LP burned at launch']" },
                "holders": { "top10Percent": "[e.g., '15%', or 'Data not found']", "details": "[e.g., 'No wallet holds more than 2%...']" },
                "prediction": { "sentiment": "[e.g., 'Bullish', 'Neutral']", "details": "[e.g., 'Strong social media activity...']" },
                "summary": "[Your overall summary...]"
              }
            }
            
            If you cannot find a specific piece of *qualitative* data, return 'Data not found' for that field, but **you must still return the full JSON object structure.**
            `;

            const apiKey = "AIzaSyDTqdv6sjLDqNQxhszCUo792so6j7mYjXw"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: geminiHistory,
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: [{ "google_search": {} }]
            };
            
            const aiText = await fetchWithBackoff(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            return aiText; 
        }

        // Play TTS (változatlan)
        async function playTTS(text) {
            try {
                const apiKey = "AIzaSyDTqdv6sjLDqNQxhszCUo792so6j7mYjXw"; 
                const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: `Say with a friendly and clear tone: ${text}` }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: { speechContext: { languageCode: "en-US" }, voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };
                const response = await fetch(ttsApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`TTS API error: ${response.statusText}`);
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;
                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    ttsAudioPlayer.src = audioUrl;
                    ttsAudioPlayer.play();
                } else { console.error("Invalid TTS response", result); }
            } catch (error) { console.error("Error during TTS playback:", error); }
        }

        // CA Másolása (MÓDOSÍTVA)
        function handleCopyClick(feedbackElement) {
            const address = contractAddressValue || document.getElementById('ca-address-desktop').textContent.trim(); 
            const textArea = document.createElement('textarea');
            textArea.value = address;
            textArea.style.position = 'absolute';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                feedbackElement.classList.remove('hidden');
                setTimeout(() => { feedbackElement.classList.add('hidden'); }, 2000);
            } catch (err) { console.error('Failed to copy text: ', err); }
            document.body.removeChild(textArea);
        }
        copyCaBtnDesktop.addEventListener('click', () => handleCopyClick(copiedFeedbackDesktop));
        copyCaBtnMobile.addEventListener('click', () => handleCopyClick(copiedFeedbackMobile));


        // Törlés gombok (változatlan)
        clearChatBtn.addEventListener('click', () => confirmationModal.classList.remove('hidden'));
        cancelDeleteBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
        confirmDeleteBtn.addEventListener('click', async () => { 
            if (!chatCollectionRef) return;
            confirmDeleteBtn.disabled = true;
            cancelDeleteBtn.disabled = true;
            try {
                const q = query(chatCollectionRef);
                const snapshot = await getDocs(q);
                const deletePromises = [];
                snapshot.docs.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));
                await Promise.all(deletePromises);
            } catch (error) { console.error("Error deleting chat history:", error); } 
            finally {
                confirmationModal.classList.add('hidden');
                confirmDeleteBtn.disabled = false;
                cancelDeleteBtn.disabled = false;
            }
        });

        // Send Message (változatlan)
        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

        // Event delegation for Play buttons (változatlan)
        chatMessages.addEventListener('click', (e) => {
            const playButton = e.target.closest('.play-tts-btn');
            if (playButton) { const textToPlay = playButton.dataset.text; if (textToPlay) { playTTS(textToPlay); } }
        });

        // --- HELPER FUNCTIONS --- (változatlanok)
        async function fetchWithBackoff(url, options, retries = 5, delay = 1000) { 
         for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`API error: ${response.status}`);
                        }
                        const errorResult = await response.json();
                        console.error("API client error:", errorResult);
                        return `Error with response: ${errorResult.error.message}`;
                    }
                    const result = await response.json();
                    if (!result.candidates || !result.candidates[0].content || !result.candidates[0].content.parts || !result.candidates[0].content.parts[0]) {
                        console.error("Invalid response structure from Gemini:", result);
                        throw new Error("Invalid response structure");
                    }
                    const text = result.candidates[0].content.parts[0].text;
                    if (!text) {
                        console.error("Empty or invalid response from Gemini:", result);
                        if(result.candidates[0].finishReason === "OTHER" || result.candidates[0].finishReason === "SAFETY") {
                            return "I tried to find the data, but I couldn't compile a valid analysis. This might be due to safety filters or lack of data. Please try asking in a different way.";
                        }
                        throw new Error("Empty response");
                    }
                    return text; // Ez most már lehet JSON string
                } catch (error) {
                    if (i === retries - 1) {
                        console.error("API call failed after all retries:", error);
                        return 'Oops, I can\'t respond. I might be overloaded. Please try again in a bit.';
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }
        function base64ToArrayBuffer(base64) { 
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        function pcmToWav(pcmData, sampleRate) { 
            const header = new ArrayBuffer(44);
            const view = new DataView(header);
            const pcmLength = pcmData.length;
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            const dataSize = pcmLength * numChannels * (bitsPerSample / 8);
            const fileSize = 36 + dataSize;
            writeString(view, 0, 'RIFF');
            view.setUint32(4, fileSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); 
            view.setUint16(20, 1, true); 
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);
            const wavData = new Int16Array(header.byteLength / 2 + pcmData.length);
            wavData.set(new Int16Array(header), 0);
            wavData.set(pcmData, header.byteLength / 2);
            return new Blob([wavData.buffer], { type: 'audio/wav' });
        }
        function writeString(view, offset, string) { 
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        // Indításkor frissítjük a CA-t
        document.addEventListener('DOMContentLoaded', updateContractAddressDisplay);
        
    </script>
</body>
</html>

